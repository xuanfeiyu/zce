# Part 3 · Vue.js 框架源码与进阶

## 模块四 · 搭建自己的SSR、静态站点生成（SSG）及封装 Vue.js 组件库

## 任务一：搭建自己的SSR

### 1.渲染一个 Vue 实例
### 2.结合到 Web 服务器中
### 3.使用 HTML 模板
### 4.在模板中使用外部数据
### 5.构建配置-基本思路
### 6.构建配置-源码结构
### 7.构建配置-安装依赖
### 8.构建配置-webpack 配置文件
### 9.构建配置-配置构建命令
### 10.构建配置-启动应用
### 11.构建配置-解析渲染流程
### 12.构建配置开发模式-基本思路
### 13.构建配置开发模式-提取处理模块
### 14.构建配置开发模式-updata 更新函数
### 15.构建配置开发模式-处理模板文件
### 16.构建配置开发模式-服务器监视打包
### 17.构建配置开发模式-把数据写入内存中
### 18.构建配置开发模式-客户端构建
### 19.构建配置开发模式-热更新
### 20.编写通用应用注意事项
### 21.路由处理-配置 VueRouter
### 22.路由处理-将路由注册到根实例
### 23.路由处理-适配服务端入口
### 24.路由处理-服务端 server 适配
### 25.路由处理-适配客户端入口
### 26.路由处理-处理完成
### 27.管理页面 Head 内容
### 28.数据预取和状态管理-思路分析
### 29.数据预取和状态管理-数据预取
### 30.数据预取和状态管理-将预取数据同步到客户端

## 任务二：静态站点生成

### 1.Gridsome基础-介绍
### 2.Gridsome基础-创建 Gridsome 项目
### 3.Gridsome基础-预渲染
### 4.Gridsome基础-目录结构
### 5.Gridsome基础-项目配置
### 6.Gridsome基础-Pages
### 7.Gridsome基础-添加集合
### 8.Gridsome基础-在 GraphQL 中查询数据
### 9.Gridsome基础-在页面中查询 GraphQL
### 10.Gridsome基础-使用模板渲染节点页面
### 11.Gridsome案例-创建项目
### 12.Gridsome案例-处理首页模板
### 13.Gridsome案例-处理其它页面模板
### 14.Gridsome案例-使用本地md文件管理文章内容
### 15.Gridsome案例-Strapi介绍
### 16.Gridsome案例-Strapi基本使用
### 17.Gridsome案例-使用Strapi接口数据
### 18.Gridsome案例-访问受保护的API
### 19.Gridsome案例-通过GraphQL访问Strapi
### 20.Gridsome案例-将Strapi数据预取到Gridsome应用中
### 21.Gridsome案例-设计文章和标签数据模型
### 22.Gridsome案例-展示文章列表
### 23.Gridsome案例-文章列表分页
### 24.Gridsome案例-展示文章详情
### 25.Gridsome案例-处理Markdown格式的文章内容
### 26.Gridsome案例-文章标签
### 27.Gridsome案例-基本设置
### 28.Gridsome案例-联系我
### 29.Gridsome案例-部署Strapi
### 30.Gridsome案例-把本地服务联通远程Strapi
### 31.Gridsome案例-部署Gridsome应用

## 任务三：封装 Vue.js 组件库

### 1.课程目标

> 开源组件库

- Element-UI
- iView

> CDD

- CDD(Component-Driven Development)
  - 自下而上
  - 从组件级别开始，到页面级别结束

> CDD 的好处

- 组件在最大程度被重用
- 并行开发
- 可视化测试

> 课程介绍

- 处理组件边界情况
- 快速原型开发
- 组件开发
- Storybook
- Monorepo
- 基于模板生成包的结构
- Lerna + yarn workspaces
- 组件测试
- Rollup 打包

### 2.处理组件的边界情况

- $root
- $parent/$children
- $refs
- 依赖注入provide/inject

### 3.attrs-listeners

- $attrs
  - 把父组件中非 prop 属性绑定到内部组件
- $listeners
  - 把父组件中的 DOM 对象的原生事件绑定到内部组件

### 4.快速原型开发

> 快速原型开发

- VueCLI 中提供了一个插件可以进行原型快速开发
- 需要先额外安装一个全局的扩展
  - npm install -g @vue/cli-service-global
- 使用 vue serve 快速查看组件的运行效果

> vue serve

- vue serve 如果不指定参数默认会在当前目录找以下入口文件
  - main.js、index.js、App.vue、app.vue

- 可以指定要加载的组件
  - vue serve ./src/login.vue

### 5.快速原型开发-ElementUI

> 安装 ElementUI

- 初始化 package.json
  - npm init -y
- 安装 ElementUI
  - vue add element
- 加载 ElementUI，使用 Vue.use() 安装插件

### 6.组件开发-步骤条组件

> 组件分类

- 第三方组件
- 基础组件
- 业务组件

### 7.组件开发-表单组件-上

> 整体结构

- Form
- FormItem
- Input
- Button

### 8.组件开发-表单组件-下

略

### 9.组件开发-表单组件-表单验证-上

- npm install async-validator

```vue
// Form
<template>
  <form>
    <slot></slot>
  </form>
</template>
<script>
export default {
    name:'LgForm',
    provide(){
        return {
            form: this
        }
    },
    props: {
        model: {
            type: Object
        },
        rules: {
            type: Object
        }
    }
}
</script>

// FormItem
<template>
  <div>
    <label>{{label}}<label>
    <div>
      <slot></slot>
      <p v-if="errMessage">{{errMessage}}</p>
    </div>
  </div>
</template>
<script>
import AsyncValidator from 'async-validator'
export default {
    name:'LgFormItem',
    inject:['form'],
    props: {
        label: {
            type: String
        },
        prop: {
            type: String
        }
    },
    mounted(){
        this.$on('validate',()=>{
            this.validate()
        })
    },
    data(){
        return {
            errMessage: ''
        }
    },
    methods: {
        validate(){
            if(!this.prop) return
            const value = this.form.model[this.prop]
            const rules = this.form.rules[this.prop]
            
            const descriptor = {[this.prop]:rules}
            const validator = new AsyncValidator(descriptor)
            return validator.validate({[this.prop]:value},errors => {
                if(errors){
                    this.errMessage = errors[0].message
                }else{
                    this.errMessage = ''
                }
            })
        }
    }
}
</script>
```

### 10.组件开发-表单组件-表单验证-下

> Input 组件验证

- Input 组件中触发自定义事件 validate
- FormItem 渲染完毕注册自定义事件 validate

```vue

// Input
<template>
  <div>
    <input v-bind="$attrs" :type="type" :value="value" @input="handleInput">
  </div>
</template>
<script>

export default {
    name:'LgInput',
    inheritAttrs: false,
    props: {
        value: {
            type: String
        },
        type: {
            type: String,
            default: 'text'
        }
    },
    methods: {
        handleInput(evt) {
            this.$emit('input', evt.target.value)
            const findParent = parent => {
                while (parent) {
                    if(parent.$options.name === 'LgFormItem') {
                        break
                    } else {
                        parent = parent.$parent
                    }
                }
                return parent
            }
            const parent = findParent(this.$parent)
            if (parent) {
                parent.$emit('validate')
            }
        }
    }
}
</script>

// Button
<template>
  <div>
    <button @click="handleClick"><slot></slot></button>
  </div>
</template>
<script>
export default {
  name: 'LoButton',
  methods: {
    handleClick(evt) {
      this.$emit('click',evt)
      evt.preventDefault()
    }
  }
}
</script>
```

### 11.Monorepo

> 两种项目的组织方式

- Multirepo(Multiple Repository)
  - 每一个包对应一个项目

- Monorepo(Monolithic Repository)
  - 一个项目仓库中管理多个模块/包

### 12.Storybook上

> Storybook

- 可视化的组件展示平台
- 在隔离的开发环境中，以交互式的方式展示组件
- 独立开发组件
- 支持的框架
  - React、React Native、Vue、Angular
  - Ember、HTML、Svelte、Mithril、Riot

> Storybook 安装

- 自动安装
  - npx -p @storybook/cli sb init --type vue
  - yarn add vue
  - yarn add vue-loader vue-template-compiler --dev
- 手动安装

### 13.Storybook下

略

### 14.yarn workspaces

> 开启 yarn 的工作区

- 项目根目录的 package.json

```javascript
"privite": true,
"workspaces": [
  "./packages/*"
]
```

> yarn workspaces 使用

- 给工作区根目录安装开发依赖
  - yarn add jest -D -W

- 给指定工作区安装依赖
  - yarn workspace lg-button add lodash@4

- 给所有工作区安装依赖
  - yarn install

### 15.Lerna上

> Lerna 介绍

- Lerna 是一个优化使用 git 和 npm 管理多包仓库的工作流工具
- 用于管理具有多个包的 JavaScript 项目
- 它可以一键把代码提交到 git 和 npm 仓库

> lerna 使用

- 全局安装
  - yarn global add lerna

- 初始化
  - lerna init

- 发布
  - lerna publish

### 16.Lerna下

略

### 17.Vue组件的单元测试

> 组件单元测试好处

- 提供描述组件行为的文档
- 节省手动测试的时间
- 减少研发新特性时产生的 bug
- 改进设计
- 促进重构

> 安装依赖

- Vue Test Utils
- Jest
- vue-jest
- babel-jest
- 安装
  - yarn add jest @vue/test-utils vue-jest babel-jest -D -W
  
### 18.Vue组件的单元测试 2
### 19.Rollup打包上
### 20.Rollup打包下
### 21.设置环境变量
### 22.清理
### 23.基于模板生成组件基本结构
### 24.基于模板生成组件基本结构2
### 25.发布
