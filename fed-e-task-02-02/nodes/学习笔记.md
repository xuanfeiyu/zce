# Part 2 · 前端工程化实践

## 模块二 · 模块化开发与规范化标准

## 任务一：模块化开发

### 1.模块化概述

- 内容概要
  - 模块化演变过程
  - 模块化规范
  - 常用的模块化打包工具
  - 基于模块化工具构建现代 Web 应用
  - 打包工具的优化技巧

### 2.模块化演变过程

- Stage1 - 文件划分方式
  - 污染全局作用域
  - 命名冲突问题
  - 无法管理模块依赖关系
  - 早期模块化完全依靠约定
- Stage2 - 命名空间方式
- Stage3 - IIFE
- 早期在没有工具和规范的情况下对模块化的落地方式

### 3.模块化规范的出现

- CommonJS 规范
  - 一个文件就是一个模块
  - 每个模块都有单独的作用域
  - 通过 module.exports 导出成员
  - 通过 require 函数载入模块
- CommonJS 是以同步模式加载模块
- AMD(Asynchronous Module Definiton)

```javascript
// 定义一个模块
define('module1', ['jquery', './module2'], function($, module2){
    return {
        start: funciton() {
            $('body').animate({ margin: 200px' })
            module2()
        }
    }
})
```
- Require.js

```javascript
// 载入一个模块
require(['./module1'], function(module1){
    module1.start()
})
```

- 目前绝大多数第三方库都支持AMD规范
- AMD 使用起来相对复杂
- 模块 JS 文件请求频繁
- Sea.js + CMD

```javascript
// CMD 规范（类似 Common.js 规范）
define(funciton (require, exports, module)) {
    // 通过 require 引入依赖
    var $ = require('jquery')
    // 通过 exports 或者 module.exports 对外暴露成员
    module.exports = function(){
        console.log('module 2~')
        $('body').append(<p>module2</p>)
    }
}
```

### 4.模块化标准规范

- 浏览器环境 ES Modules
- NodeJs 环境 Common.js

### 5.ES Modules 特性

- 自动采用严格模式，忽略'use strict'
- 每个 ESM 模块都是单独的私有作用域
- ESM 是通过 cors 去请求外部 JS 模块的
- ESM 的 script 标签会延迟执行脚本

### 6.ES Modules 导出

```javascript
// ./module.js
const foo = 'es modules'
export { foo }

// ./app.js
import { foo } from './module.js'
console.log(foo) // es modules
```

### 7.ES Modules 导入导出的注意事项

- export 后面大括号是固定语法，不是对象字面量。 export default { name, age } 是对象字面量。
- import 不是解构，就是固定用法。
- 导出是把值存放的地址导出，不是复制。
- 导入的成员是只读成员，不能修改。

### 8.ES Modules 导入用法

- 需要完整路径和扩展名，不能省略 ./

```javascript
import {} from './module.js'
import './module.js'
import * as mod from './module.js'
import('./moudle.js').then(function(module){
    console.log(module)
})
import { name, age, default as title } rom './module.js'
import title, { name, age } rom './module.js'

```

### 9.ES Modules 导出导入成员

```javascript
// idnex.js
import { Button } from './button.js'
import { Avatar } from './avatar.js'
export { Button, Avatar }
```

### 10.ES Modules 浏览器环境 Polyfill

```javascript
<script nomodule src="https://unpkg.com/promise-polyfill@8.1.3/dist/polyfill.min.js"></script>
<script nomodule src="https://unpkg.com/browser-es-moudle-loader@0.4.1/dist/babel-browser-build.js"></script>
<script nomodule src="https://unpkg.com/browser-es-moudle-loader@0.4.1/dist/browser-es-module-loader.js"></script>
```

### 11.ES Modules in Node.js - 支持情况

- node --experimental-modules index.mjs

```javascript
// 支持
import _ from 'lodash'
console.log(_.cameClass('ES Module'))
// 不支持，因为第三方模块都是导出默认成员
import { cameClass } from 'lodash'
console.log(cameClass('ES Module'))
// 内置模块兼容了 ESM 的提取成员方式
import { writeFileSunc } from 'fs'
writeFileSunc('./bar.txt', 'es module working~')
```

### 12.ES Modules in Node.js - 与 CommonjS 交互

- ES Module 中可以导入 CommonJS 模块
- CommonJS 中不能导入 ES Modules 模块
- CommonJS 模块始终只会导出一个默认成员
- 注意 import 不是解构导出对象

```javascript
// es-module.mjs
// ES Module 中可以导入 CommonJS 模块
import mod from './commonjs.js'
console.log(mod)
// 不能直接提取成员，注意 import 不是解构导出对象
import { foo } from './commonjs.js'
console.log(foo)

export const foo = 'es module export value'

// commonjs.js
// CommonJS 模块始终只会导出一个默认成员
module.exports = {
  foo: 'commonjs exports value'
}
exports.foo = 'commonjs exports value'
// 不能再 CommonJS 模块中通过 require 载入 ES Module
const mod = require('./es-module.mjs')
console.log(mod)
```

### 13.ES Modules in Node.js - 与 CommonjS 的差异

```javascript
// esm.mjs
// ESM 中没有 CommonJS 中那些模块全局成员了
import { fileURLToPath } from 'url'
import { dirname } from 'path'
const __filename = fileURLToPath(import.meta.url)
console.log(__filename)
const __dirname = dirname(__filename)
console.log(__dirname)
```

### 14.ES Modules in Node.js - 新版本进一步支持

```javascript
// pakage.json
{
  "type": "module"
}
// common.cjs
```

### 15.ES Modules in Node.js - Babel 兼容方案

- yarn add @babel/node @babel/core @babel/preset-env --dev
- yarn babel-node
- yarn babel-node index.js --presets=@babel/preset-env

- yarn add @babel/plugin-transform-modules-commonjs
```javascript
// .babelrc
{
  "presets": ["@babel/preset-env"]
}
// .babelrc
{
  "plugins": ["@babel/plugin-transform-modules-commonjs"]
}
```

## 任务二：Webpack打包

### 1.模块打包工具的由来
